¬°Excelente! Un nombramiento de archivo estandarizado es crucial para la organizaci√≥n y la gesti√≥n por parte de los profesores. Entiendo perfectamente la necesidad de extraer el ID del recurso de la URL, abreviar el t√≠tulo del v√≠deo e incluir las iniciales del usuario.
Vamos a implementar estos requisitos en la funci√≥n generateBaseFileName() para que todos los tipos de descarga (PDF, Imagen, ZIP) utilicen este nuevo formato.
Plan de Acci√≥n:
1.	Obtener el ID del Recurso:
o	La clave ser√° inspeccionar el href del √∫ltimo <a> dentro de la ol.breadcrumb que no sea el actual (es decir, el pen√∫ltimo breadcrumb-item si "Editar la entrega" es el √∫ltimo, o el √∫ltimo si es directamente la p√°gina/tarea).
o	La URL tendr√° un formato .../mod/assign/view.php?id=XYZ o .../mod/page/view.php?id=XYZ. Podemos usar URLSearchParams para extraer el valor del par√°metro id.
o	Esta extracci√≥n debe ser lo m√°s robusta posible, buscando el patr√≥n id=NUMERO en el href.
2.	Abreviar el T√≠tulo del V√≠deo:
o	Tomaremos el currentVideoTitle que ya tenemos.
o	Eliminaremos espacios, caracteres especiales (manteniendo solo alfanum√©ricos) y concatenaremos las palabras si es necesario para formar una cadena continua.
3.	Obtener Iniciales del Usuario:
o	Utilizaremos el nombre completo del usuario obtenido por getMoodleUserName().
o	Dividiremos el nombre por espacios y tomaremos la primera letra de cada parte, las convertiremos a may√∫sculas y las concatenaremos.
4.	Integrar en generateBaseFileName(): Modificaremos esta funci√≥n para que combine estos tres componentes en el formato [ID del Recurso]_[T√≠tulo del V√≠deo Abreviado]_[Iniciales del Nombre del Usuario].
Aqu√≠ tienes el c√≥digo actualizado con la implementaci√≥n de esta convenci√≥n de nombrado:
Puntos clave de los cambios:
‚Ä¢	getResourceIdFromMoodleUrl() (nueva funci√≥n): Intenta encontrar el href del breadcrumb que contiene el ID de recurso y lo extrae. Tiene una l√≥gica de fallback si no lo encuentra.
‚Ä¢	getInitials() (nueva funci√≥n): Procesa el nombre completo del usuario para obtener las iniciales.
‚Ä¢	cleanAndAbbreviateVideoTitle() (nueva funci√≥n): Limpia y abrevia el t√≠tulo del v√≠deo.
‚Ä¢	generateBaseFileName() modificada: Ahora ensambla los tres componentes utilizando las nuevas funciones auxiliares.
‚Ä¢	Uso del nuevo nombre de archivo: Todas las funciones de descarga (downloadPdf, downloadImage, downloadZip) y la funci√≥n de subida a Moodle (submitFileToMoodle) ahora utilizan el nombre de archivo generado por generateBaseFileName().
Generated html
<!-- Contenedor principal que centrar√° todo el contenido de la herramienta -->
<div class="main-centered-container"><!-- Contenedor del selector de v√≠deo -->
  <div class="video-selector-card">
    <h1>Seleccione un v√≠deo:</h1>
    <div class="select-wrapper"><select id="videoSelect">
        <option disabled="disabled" selected="selected" value="">Cargando
          v√≠deos...</option>
      </select></div>
  </div>
  <!-- Contenedor que agrupa el reproductor de v√≠deo y el formulario de marcado -->
  <div class="video-and-form-wrapper">
    <!-- Contenedor del reproductor de v√≠deo (inicialmente oculto) -->
    <div id="videoPlayerCard" class="video-player-card" style="display: none;">
      <!-- Contenedor para el v√≠deo y el canvas superpuesto -->
      <div class="video-canvas-wrapper"><video id="mainVideoPlayer"
          controls="controls"></video> <canvas id="markingCanvas"
          style="display: none;"></canvas> <!-- Canvas para dibujar -->
        <div id="annotationTooltip" class="annotation-tooltip"
          style="display: none;"></div>
        <!-- Tooltip -->
      </div>
      <p id="videoPlaceholder" class="video-placeholder">Seleccione un v√≠deo
        para comenzar</p>
      <!-- Contenedor para los botones personalizados -->
      <div class="custom-video-controls"><button id="playFromStartButton"
          class="custom-button primary-button">Reproducir</button> <button
          id="markButton" class="custom-button secondary-button">Marcar</button>
      </div>
    </div>
    <!-- Contenedor del formulario de marcado (inicialmente oculto) -->
    <div id="markingFormCard" class="marking-form-card" style="display: none;">
      <h2>A√±adir marca</h2>
      <!-- Selector de color -->
      <div class="form-group"><label for="colorSelect">Color</label>
        <div class="select-wrapper"><select id="colorSelect">
            <option value="red">üî¥ Rojo</option>
            <option value="green">üü¢ Verde</option>
            <option selected="selected" value="blue">üîµ Azul</option>
            <option value="yellow">üü° Amarillo</option>
            <option value="purple">üü£ Morado</option>
            <option value="orange">üü† Naranja</option>
          </select></div>
      </div>
      <!-- Aqu√≠ se generar√°n los campos del formulario din√°micamente -->
      <div id="dynamicFormFields"></div>
      <button id="addAnnotationButton" class="custom-button annotation-button"
        disabled="disabled">A√±adir Anotaci√≥n</button>
      <!-- Nuevo bot√≥n para las opciones de informe/entrega --> <button
        id="reportActionButton" class="custom-button report-button"
        style="display: none;"></button>
    </div>
  </div>
</div>
<!-- Ventana Modal de Informe -->
<div id="reportModalOverlay" class="report-modal-overlay"
  style="display: none;">
  <div class="report-modal-content"><span class="close-button">√ó</span>
    <h2 class="modal-title"> </h2>
    <div class="modal-body"><!-- Contenido din√°mico aqu√≠ -->
      <section class="modal-section">
        <h3><strong>Informaci√≥n General</strong></h3>
        <p>Usuario: <span id="reportUser"></span></p>
        <p>T√≠tulo del v√≠deo: <span id="reportVideoTitle"></span></p>
        <p>Instante de tiempo: <span id="reportMarkTime"></span></p>
        <div class="image-previews">
          <div class="image-preview-item">
            <h4>Fotograma original</h4>
            <img id="originalFrameImage" alt="Fotograma original">
            <p class="error-message" style="display: none;">No se pudo cargar la
              imagen del fotograma debido a restricciones de seguridad (CORS) o
              el v√≠deo no est√° listo.</p>
          </div>
          <div class="image-preview-item">
            <h4>Fotograma con marcas</h4>
            <img id="markedFrameImage" alt="Fotograma con marcas">
            <p class="error-message" style="display: none;">No se pudo cargar la
              imagen del fotograma debido a restricciones de seguridad (CORS) o
              el v√≠deo no est√° listo.</p>
          </div>
        </div>
      </section>
      <section class="modal-section">
        <h3><strong>Informaci√≥n del Marcado</strong></h3>
        <ol id="marksList"><!-- Marcas se insertar√°n aqu√≠ --></ol>
      </section>
    </div>
    <div id="modalFooterButtons" class="modal-footer">
      <!-- Botones se insertar√°n aqu√≠ --></div>
  </div>
</div>
<p>
  <!-- Librer√≠as para la generaci√≥n de PDF y ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // === CONFIGURACI√ìN IMPORTANTE ===
      const MOODLE_CONTEXT_ID =
        '605943'; // <<-- ¬°MODIFICA ESTO CON EL ID CORRECTO DE TU CARPETA!
      const FOLDER_PATH = 'Bloque%201/';
      const MOODLE_BASE_URL = window.location.origin;
      const FILES_BASE_URL = MOODLE_BASE_URL +
        `/pluginfile.php/${MOODLE_CONTEXT_ID}/mod_folder/content/0/${FOLDER_PATH}`;
      const JSON_FILENAME_TO_LOAD = 'data.json';

      // === NUEVA CONFIGURACI√ìN: TIPO DE RECURSO MOODLE ===
      const MOODLE_RESOURCE_TYPE =
        'page'; // O 'assign'. MODIFICA ESTO MANUALMENTE.

      // Referencias a elementos del DOM
      const videoSelect = document.getElementById('videoSelect');
      const videoPlayerCard = document.getElementById('videoPlayerCard');
      const mainVideoPlayer = document.getElementById('mainVideoPlayer');
      const videoPlaceholder = document.getElementById('videoPlaceholder');
      const playFromStartButton = document.getElementById(
        'playFromStartButton');
      const markButton = document.getElementById('markButton');
      const markingFormCard = document.getElementById('markingFormCard');
      const dynamicFormFields = document.getElementById(
        'dynamicFormFields');
      const addAnnotationButton = document.getElementById(
        'addAnnotationButton');
      const markingCanvas = document.getElementById('markingCanvas');
      const colorSelect = document.getElementById('colorSelect');
      const annotationTooltip = document.getElementById(
        'annotationTooltip');
      const reportActionButton = document.getElementById(
        'reportActionButton'); // Nuevo bot√≥n de informe
      const customVideoControls = document.querySelector(
        '.custom-video-controls'
      ); // Referencia a los controles de v√≠deo personalizados


      // Referencias a elementos de la Modal
      const reportModalOverlay = document.getElementById(
        'reportModalOverlay');
      const modalTitle = reportModalOverlay.querySelector('.modal-title');
      const closeButton = reportModalOverlay.querySelector('.close-button');
      const reportUser = document.getElementById('reportUser');
      const reportVideoTitle = document.getElementById('reportVideoTitle');
      const reportMarkTime = document.getElementById('reportMarkTime');
      const originalFrameImage = document.getElementById(
        'originalFrameImage');
      const markedFrameImage = document.getElementById('markedFrameImage');
      const marksList = document.getElementById('marksList');
      const modalFooterButtons = document.getElementById(
        'modalFooterButtons');


      // Variables de estado
      let formFieldsDefinition = [];
      let canvasContext = markingCanvas.getContext('2d');
      let circleDrawn = false;

      let isDrawing = false;
      let startX,
        startY; // Coordenadas de inicio del arrastre (relativas al canvas)
      // currentCircle ahora almacena {x, y, radius, color, widthAtCapture, heightAtCapture}
      let currentCircle = null;

      // Cada anotaci√≥n almacenar√° {number, time, x, y, radius, color, formFields, widthAtCapture, heightAtCapture}
      let videoAnnotations = [];
      let playerResizeObserver;
      let currentVideoTitle =
        ''; // Variable para almacenar el t√≠tulo del v√≠deo actual


      // Funci√≥n para obtener el nombre de usuario de Moodle
      function getMoodleUserName() {
        // 1. Intentar obtener del title del span.userbutton (Prioritario seg√∫n la instrucci√≥n)
        const userButton = document.querySelector('.userbutton');
        if (userButton && userButton.title) {
          return userButton.title.trim();
        }

        // 2. Fallback 1: Si no se encuentra, intentar con el texto del usertext dentro del dropdown-toggle
        const userMenuToggle = document.querySelector(
          '.usermenu .dropdown-toggle');
        if (userMenuToggle) {
          const userNameSpan = userMenuToggle.querySelector('.usertext');
          if (userNameSpan) {
            return userNameSpan.textContent.trim();
          }
          // 3. Fallback 2: Si no, intentar con el title/data-title del dropdown-toggle
          const title = userMenuToggle.getAttribute('title') ||
            userMenuToggle
            .dataset.title;
          if (title && title.includes('Men√∫ de usuario para')) {
            return title.replace('Men√∫ de usuario para ', '').trim();
          }
        }

        // √öltimo recurso si no se encuentra en ning√∫n lugar
        return '[Nombre de usuario Moodle no disponible]';
      }

      // NUEVA FUNCI√ìN: Obtener ID del recurso de la URL del breadcrumb
      function getResourceIdFromMoodleUrl() {
          const breadcrumbLink = document.querySelector('.breadcrumb-item:nth-last-child(2) a');
          if (breadcrumbLink) {
              const href = breadcrumbLink.href;
              const url = new URL(href);
              const id = url.searchParams.get('id');
              if (id) {
                  return id;
              }
          }
          // Fallback si no se encuentra el ID en el breadcrumb
          console.warn('Could not find Moodle resource ID in breadcrumb URL. Using default ID.');
          // Podr√≠as devolver un valor gen√©rico o un ID por defecto si no se encuentra
          return 'UNKNOWN'; 
      }

      // NUEVA FUNCI√ìN: Obtener iniciales del nombre de usuario
      function getInitials(fullName) {
          if (!fullName) return '';
          const parts = fullName.split(' ').filter(part => part.length > 0);
          const initials = parts.map(part => part[0]).join('');
          return initials.toUpperCase();
      }

      // NUEVA FUNCI√ìN: Limpiar y abreviar el t√≠tulo del v√≠deo
      function cleanAndAbbreviateVideoTitle(title) {
          if (!title) return '';
          // Elimina caracteres no alfanum√©ricos y espacios, luego une
          return title.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
      }


      // Funci√≥n para generar el nombre base del archivo (alumno_tituloVideo)
      function generateBaseFileName() {
        // [ID del Recurso]_[T√≠tulo del V√≠deo Abreviado]_[Iniciales del Nombre del Usuario]
        const resourceId = getResourceIdFromMoodleUrl();
        const abbreviatedVideoTitle = cleanAndAbbreviateVideoTitle(currentVideoTitle);
        const userInitials = getInitials(getMoodleUserName());
          
        // Aseg√∫rate de que no haya caracteres especiales o dobles guiones bajos
        const fileNameParts = [resourceId, abbreviatedVideoTitle, userInitials].filter(Boolean); // Elimina elementos vac√≠os
        return fileNameParts.join('_').replace(/__+/g, '_').replace(/^_|_$/g, ''); // Limpia dobles/extremos guiones bajos
      }


      // Funci√≥n para configurar el texto y comportamiento del nuevo bot√≥n de informe
      function setupReportButton() {
        if (MOODLE_RESOURCE_TYPE === 'page') {
          reportActionButton.textContent = 'Opciones de descarga';
          reportActionButton.classList.add('secondary-button');
          reportActionButton.classList.remove('primary-button');
          reportActionButton.onclick = showReportModal;
        } else if (MOODLE_RESOURCE_TYPE === 'assign') {
          reportActionButton.textContent = 'Entregar informe';
          reportActionButton.classList.add('primary-button');
          reportActionButton.classList.add(
            'confirm-submit-button'); // Clase adicional para el verde
          reportActionButton.classList.remove('secondary-button');
          reportActionButton.onclick = showReportModal;
        } else {
          reportActionButton.style.display = 'none';
        }
      }

      async function loadData(jsonFilename) {
        videoSelect.innerHTML =
          '<option value="" disabled selected>Cargando v√≠deos...</option>';
        try {
          const response = await fetch(FILES_BASE_URL + jsonFilename);
          if (!response.ok) throw new Error(
            `HTTP error! status: ${response.status}`);
          const data = await response.json();

          videoSelect.innerHTML =
            '<option value="" disabled selected>Seleccione un v√≠deo</option>';
          data.videos.forEach(video => {
            const option = document.createElement('option');
            option.value = FILES_BASE_URL + video.url +
              '?forcedownload=1';
            option.textContent = video.nombre;
            option.dataset.videoName = video
              .nombre; // Guardar el nombre original para el informe
            videoSelect.appendChild(option);
          });
          formFieldsDefinition = data.camposFormulario && Array.isArray(
            data.camposFormulario) ? data.camposFormulario : [];
          setupReportButton();
        } catch (error) {
          console.error('Error al cargar los datos:', error);
          videoSelect.innerHTML =
            '<option value="" disabled selected>Error al cargar v√≠deos</option>';
          alert(
            'No se pudieron cargar los datos. Por favor, verifique la configuraci√≥n o la disponibilidad de los archivos.'
          );
        }
      }

      function generateFormFields() {
        dynamicFormFields.innerHTML = '';
        formFieldsDefinition.forEach((field, index) => {
          const formGroup = document.createElement('div');
          formGroup.classList.add('form-group');

          const label = document.createElement('label');
          label.textContent = field.etiqueta;
          label.setAttribute('for', `field-${index}`);

          let inputElement;
          if (field.tipo === 'textarea') {
            inputElement = document.createElement('textarea');
            inputElement.placeholder = 'Breve descripci√≥n...';
            inputElement.rows = 4;
          } else {
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.placeholder = field.etiqueta.replace(':', '')
              .trim();
          }
          inputElement.id = `field-${index}`;
          inputElement.classList.add('form-input');
          inputElement.addEventListener('input', checkButtonState);

          formGroup.appendChild(label);
          formGroup.appendChild(inputElement);
          dynamicFormFields.appendChild(formGroup);
        });
        checkButtonState();
      }

      // Funci√≥n para dibujar un c√≠rculo con n√∫mero en un contexto dado
      function drawCircleWithNumberOnContext(ctx, annotation, targetWidth,
        targetHeight) {
        // Calcular las coordenadas escaladas y el radio
        const scaledX = (annotation.x / annotation.widthAtCapture) *
          targetWidth;
        const scaledY = (annotation.y / annotation.heightAtCapture) *
          targetHeight;
        // Escalar el radio de forma proporcional al menor de los lados para evitar distorsi√≥n severa
        const scaleFactor = Math.min(targetWidth / annotation
          .widthAtCapture,
          targetHeight / annotation.heightAtCapture);
        const scaledRadius = annotation.radius * scaleFactor;


        ctx.beginPath();
        ctx.arc(scaledX, scaledY, scaledRadius, 0, Math.PI * 2, false);
        ctx.strokeStyle = annotation.color;
        ctx.lineWidth = 3;
        ctx.stroke();

        ctx.fillStyle = annotation.color;
        ctx.font = 'bold 20px Arial'; // Tama√±o de fuente para el n√∫mero
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const textX = scaledX;
        const textY = scaledY - scaledRadius -
          15; // 15px por encima del c√≠rculo escalado

        ctx.fillText(annotation.number.toString(), textX, textY);
      }

      // Funci√≥n principal para dibujar todos los c√≠rculos (fijos y temporal) en el canvas de marcado
      function drawAllCircles() {
        canvasContext.clearRect(0, 0, markingCanvas.width, markingCanvas
          .height);

        // Dibujar todos los c√≠rculos de anotaciones previas (fijas) y sus n√∫meros
        videoAnnotations.forEach(annotation => {
          drawCircleWithNumberOnContext(
            canvasContext,
            annotation,
            markingCanvas.width,
            markingCanvas.height
          );
        });

        // Dibujar el c√≠rculo TEMPORAL si existe
        if (currentCircle && (isDrawing || circleDrawn)) {
          canvasContext.beginPath();
          canvasContext.arc(currentCircle.x, currentCircle.y, currentCircle
            .radius, 0, Math.PI * 2, false);
          canvasContext.strokeStyle = currentCircle.color;
          canvasContext.lineWidth = 3;
          canvasContext.stroke();
        }
      }

      function getMousePos(canvas, event) {
        const rect = canvas.getBoundingClientRect();
        return {
          x: event.clientX - rect.left,
          y: event.clientY - rect.top
        };
      }

      function handleMouseDown(event) {
        if (event.button !== 0) return;
        isDrawing = true;
        const pos = getMousePos(markingCanvas, event);
        startX = pos.x;
        startY = pos.y;
        currentCircle = null;
        circleDrawn = false;
        drawAllCircles();
        checkButtonState();
      }

      function handleMouseMove(event) {
        if (!isDrawing) {
          handleHover(event);
          return;
        }
        const pos = getMousePos(markingCanvas, event);
        const currentX = pos.x;
        const currentY = pos.y;

        const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(
          currentY - startY, 2));

        const selectedColor = colorSelect.value;
        currentCircle = {
          x: startX,
          y: startY,
          radius: radius,
          color: selectedColor
        };
        drawAllCircles();
      }

      function handleMouseUp(event) {
        if (!isDrawing) return;
        isDrawing = false;

        const pos = getMousePos(markingCanvas, event);
        const endX = pos.x;
        const endY = pos.y;

        const finalRadius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(
          endY - startY, 2));

        if (finalRadius > 5) {
          const selectedColor = colorSelect.value;
          currentCircle = {
            x: startX,
            y: startY,
            radius: finalRadius,
            color: selectedColor,
            widthAtCapture: markingCanvas
              .width, // Guardar las dimensiones del canvas al dibujar
            heightAtCapture: markingCanvas.height
          };
          circleDrawn = true;
        } else {
          currentCircle = null;
          circleDrawn = false;
        }
        drawAllCircles();
        checkButtonState();
      }

      function handleMouseOut(event) {
        if (!isDrawing) {
          annotationTooltip.style.display = 'none';
        }
      }

      function getCircleAtPoint(x, y) {
        for (let i = videoAnnotations.length - 1; i >= 0; i--) {
          const annotation = videoAnnotations[i];
          const currentCanvasWidth = markingCanvas.width;
          const currentCanvasHeight = markingCanvas.height;
          // Escalar la posici√≥n y radio de la anotaci√≥n fija a las dimensiones actuales del canvas para la detecci√≥n
          const scaledX = (annotation.x / annotation.widthAtCapture) *
            currentCanvasWidth;
          const scaledY = (annotation.y / annotation.heightAtCapture) *
            currentCanvasHeight;
          const scaleFactor = Math.min(currentCanvasWidth / annotation
            .widthAtCapture, currentCanvasHeight / annotation
            .heightAtCapture);
          const scaledRadius = annotation.radius * scaleFactor;


          const distance = Math.sqrt(Math.pow(x - scaledX, 2) + Math.pow(
            y - scaledY, 2));
          if (distance <= scaledRadius) {
            return annotation;
          }
        }
        return null;
      }

      function handleHover(event) {
        const mousePos = getMousePos(markingCanvas, event);
        const hoveredAnnotation = getCircleAtPoint(mousePos.x, mousePos.y);

        if (hoveredAnnotation) {
          annotationTooltip.style.display = 'block';
          annotationTooltip.style.left = `${event.clientX + 10}px`;
          annotationTooltip.style.top = `${event.clientY + 10}px`;

          let contentHTML = '';
          if (hoveredAnnotation.formFields) {
            const formFieldsArray = formFieldsDefinition.map(fieldDef => {
              const cleanedLabel = fieldDef.etiqueta.replace(':', '')
                .trim();
              return {
                label: cleanedLabel,
                value: hoveredAnnotation.formFields[cleanedLabel] || ''
              };
            });

            if (formFieldsArray.length > 0) {
              contentHTML +=
                `<strong>${formFieldsArray[0].value}</strong><br>`;
            }
            if (formFieldsArray.length > 1) {
              contentHTML += `<span>${formFieldsArray[1].value}</span>`;
            }
          } else {
            contentHTML = 'No info.';
          }

          annotationTooltip.innerHTML = contentHTML;
        } else {
          annotationTooltip.style.display = 'none';
        }
      }

      function areFormFieldsFilled() {
        const inputElements = dynamicFormFields.querySelectorAll(
          '.form-input');
        for (let i = 0; i < inputElements.length; i++) {
          if (inputElements[i].value.trim() === '') {
            return false;
          }
        }
        return true;
      }

      function checkButtonState() {
        const allConditionsMet = circleDrawn && areFormFieldsFilled();
        addAnnotationButton.disabled = !allConditionsMet;
        if (allConditionsMet) {
          addAnnotationButton.classList.remove('disabled-button');
        } else {
          addAnnotationButton.classList.add('disabled-button');
        }
      }

      function resetMarkingForm() {
        dynamicFormFields.querySelectorAll('.form-input').forEach(input =>
          input.value = '');
        colorSelect.value = 'blue';
      }

      function handleVideoSelection() {
        const selectedOption = videoSelect.options[videoSelect
          .selectedIndex];
        const selectedVideoUrl = videoSelect.value;

        if (selectedVideoUrl) {
          mainVideoPlayer.src = selectedVideoUrl;
          mainVideoPlayer.load();
          // Almacenar el t√≠tulo del v√≠deo seleccionado
          currentVideoTitle = selectedOption.dataset.videoName ||
            selectedOption
            .textContent;


          mainVideoPlayer.addEventListener('error',
            function videoLoadErrorHandler() {
              alert(
                'Error: El v√≠deo seleccionado no pudo ser cargado. Es posible que el archivo no exista o est√© da√±ado.'
              );
              videoSelect.value = '';
              mainVideoPlayer.pause();
              mainVideoPlayer.src = "";
              videoPlayerCard.style.display = 'none';
              markingFormCard.style.display = 'none';
              videoPlaceholder.style.display = 'block';
              markingCanvas.style.display = 'none';
              canvasContext.clearRect(0, 0, markingCanvas.width,
                markingCanvas.height);
              circleDrawn = false;
              currentCircle = null;
              videoAnnotations = [];
              resetMarkingForm();
              checkButtonState();
              annotationTooltip.style.display = 'none';
              customVideoControls.style.display =
                'flex'; // Mostrar controles al error
              reportActionButton.style.display = 'none';
              this.removeEventListener('error',
                videoLoadErrorHandler);
            }, {
              once: true
            });

          videoPlayerCard.style.display = 'flex';
          videoPlayerCard.classList.remove('shrink-player');
          markingFormCard.style.display = 'none';
          videoPlaceholder.style.display = 'none';
          markingFormCard.style.minHeight = 'auto';

          markingCanvas.style.display = 'none';
          markingCanvas.removeEventListener('mousedown', handleMouseDown);
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
          markingCanvas.removeEventListener('mouseout',
            handleMouseOut);
          canvasContext.clearRect(0, 0, markingCanvas.width, markingCanvas
            .height);
          circleDrawn = false;
          currentCircle = null;
          videoAnnotations = [];
          resetMarkingForm();
          checkButtonState();
          annotationTooltip.style.display = 'none';

          customVideoControls.style.display =
            'flex'; // Mostrar los controles de v√≠deo personalizados
          reportActionButton.style.display =
            'none'; // Ocultar el bot√≥n de informe al seleccionar un v√≠deo nuevo/reiniciar.

        } else {
          mainVideoPlayer.pause();
          mainVideoPlayer.src = "";
          videoPlayerCard.style.display = 'none';
          markingFormCard.style.display = 'none';
          markingFormCard.style.minHeight = 'auto';

          markingCanvas.style.display = 'none';
          markingCanvas.removeEventListener('mousedown', handleMouseDown);
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
          markingCanvas.removeEventListener('mouseout',
            handleMouseOut);
          canvasContext.clearRect(0, 0, markingCanvas.width, markingCanvas
            .height);
          circleDrawn = false;
          currentCircle = null;
          videoAnnotations = [];
          resetMarkingForm();
          checkButtonState();
          annotationTooltip.style.display = 'none';

          customVideoControls.style.display =
            'flex'; // Mostrar los controles de v√≠deo personalizados
          reportActionButton.style.display =
            'none'; // Ocultar el bot√≥n de informe si no hay v√≠deo seleccionado
        }
      }

      function adjustFormHeight() {
        requestAnimationFrame(() => {
          const playerHeight = videoPlayerCard.offsetHeight;
          if (playerHeight > 0) {
            markingFormCard.style.minHeight = `${playerHeight}px`;
            markingCanvas.width = mainVideoPlayer.offsetWidth;
            markingCanvas.height = mainVideoPlayer.offsetHeight;

            drawAllCircles();
          }
        });
      }

      markButton.addEventListener('click', function() {
        if (mainVideoPlayer.src) {
          mainVideoPlayer.pause();
          // Ocultar controles nativos del v√≠deo
          mainVideoPlayer.removeAttribute('controls');
          // MODIFICADO: NO ocultar los controles personalizados al entrar en modo marcado
          customVideoControls.style.display =
            'flex'; // Mantener visibles

          generateFormFields();

          videoPlayerCard.classList.add('shrink-player');
          markingFormCard.style.display = 'flex';

          markingCanvas.style.display = 'block';
          markingCanvas.width = mainVideoPlayer.offsetWidth;
          markingCanvas.height = mainVideoPlayer.offsetHeight;

          currentCircle = null;
          circleDrawn = false;
          resetMarkingForm();
          checkButtonState();

          drawAllCircles();

          markingCanvas.addEventListener('mousedown', handleMouseDown);
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
          markingCanvas.addEventListener('mouseout',
            handleMouseOut);

          if (playerResizeObserver) {
            playerResizeObserver.disconnect();
          }
          playerResizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
              if (entry.target === videoPlayerCard) {
                adjustFormHeight();
              }
            }
          });
          playerResizeObserver.observe(videoPlayerCard);
          adjustFormHeight();

          reportActionButton.style.display = 'block';
        }
      });

      playFromStartButton.addEventListener('click', function() {
        if (mainVideoPlayer.src) {
          mainVideoPlayer.currentTime = 0;
          mainVideoPlayer.play();
          // Mostrar controles nativos del v√≠deo
          mainVideoPlayer.setAttribute('controls', 'true');
          // Mostrar los controles personalizados al iniciar la reproducci√≥n
          customVideoControls.style.display = 'flex';

          videoPlayerCard.classList.remove('shrink-player');
          markingFormCard.style.display = 'none';
          markingFormCard.style.minHeight = 'auto';

          markingCanvas.style.display = 'none';
          markingCanvas.removeEventListener('mousedown',
            handleMouseDown);
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
          markingCanvas.removeEventListener('mouseout',
            handleMouseOut);
          canvasContext.clearRect(0, 0, markingCanvas.width,
            markingCanvas.height); // Corregido: Usar markingCanvas.height
          circleDrawn = false;
          currentCircle = null;
          videoAnnotations
            = []; // Limpiar todas las anotaciones al reiniciar (como se pide)
          resetMarkingForm();
          checkButtonState();
          annotationTooltip.style.display = 'none';

          mainVideoPlayer.addEventListener('error',
            function videoPlayErrorHandler() {
              alert(
                'Error: El v√≠deo no pudo ser reproducido. Es posible que el archivo no exista o est√© da√±ado.'
              );
              videoSelect.value = '';
              mainVideoPlayer.pause();
              mainVideoPlayer.src = "";
              videoPlayerCard.style.display = 'none';
              markingFormCard.style.display = 'none';
              videoPlaceholder.style.display = 'block';
              markingCanvas.style.display = 'none';
              canvasContext.clearRect(0, 0, markingCanvas.width,
                markingCanvas.height);
              circleDrawn = false;
              currentCircle = null;
              videoAnnotations = [];
              resetMarkingForm();
              checkButtonState();
              customVideoControls.style.display =
                'flex'; // Mostrar controles al error
              this.removeEventListener('error',
                videoPlayErrorHandler);
            }, {
              once: true
            });

          if (playerResizeObserver) {
            playerResizeObserver.disconnect();
            playerResizeObserver = null;
          }
          reportActionButton.style.display = 'none';
        }
      });

      videoSelect.addEventListener('change', handleVideoSelection);

      addAnnotationButton.addEventListener('click', function() {
        if (!currentCircle) {
          alert('Error: No hay un c√≠rculo v√°lido para a√±adir.');
          return;
        }

        const formValues = {};
        formFieldsDefinition.forEach((field, index) => {
          const input = document.getElementById(`field-${index}`);
          if (input) {
            const cleanedLabel = field.etiqueta.replace(':', '')
              .trim();
            formValues[cleanedLabel] = input.value.trim();
          }
        });

        const newAnnotation = {
          number: videoAnnotations.length +
            1, // Nuevo: Asignar n√∫mero consecutivo
          time: mainVideoPlayer.currentTime,
          x: currentCircle.x,
          y: currentCircle.y,
          radius: currentCircle.radius,
          color: currentCircle.color,
          formFields: formValues,
          // Guardar las dimensiones del canvas al momento de la anotaci√≥n
          widthAtCapture: currentCircle
            .widthAtCapture, // Usar las dimensiones guardadas en currentCircle
          heightAtCapture: currentCircle.heightAtCapture
        };
        videoAnnotations.push(
          newAnnotation);
        console.log("Anotaci√≥n a√±adida:", newAnnotation);

        currentCircle = null;
        circleDrawn = false;
        resetMarkingForm();

        drawAllCircles
          (); // Redibujar para mostrar el nuevo c√≠rculo fijo con su n√∫mero
        checkButtonState();
      });

      // Funci√≥n para generar el texto del informe para los ficheros TXT/PDF
      function generateReportTextContent() {
        let textContent = `Informe de Marcado de V√≠deo\n\n`;

        textContent += `Informaci√≥n General:\n`;
        textContent += `Usuario: ${getMoodleUserName()}\n`;
        textContent += `T√≠tulo del v√≠deo: ${currentVideoTitle}\n`;
        textContent +=
          `Instante de tiempo: ${mainVideoPlayer.currentTime.toFixed(2)} segundos\n\n`;

        textContent += `Informaci√≥n del Marcado:\n`;
        if (videoAnnotations.length === 0) {
          textContent += 'No se han a√±adido marcas.\n';
        } else {
          videoAnnotations.forEach(annotation => {
            textContent +=
              `\nMarca ${annotation.number} (Color: ${annotation.color}):\n`;
            textContent +=
              `Posici√≥n: (X = ${annotation.x.toFixed(2)}; Y = ${annotation.y.toFixed(2)})\n`;
            if (annotation.formFields) {
              formFieldsDefinition.forEach(fieldDef => {
                // Eliminar el ": " o ":" extra si ya est√° en la etiqueta del JSON
                const labelForText = fieldDef.etiqueta.endsWith(':') ? fieldDef.etiqueta : `${fieldDef.etiqueta}:`;
                const value = annotation.formFields[fieldDef.etiqueta.replace(':', '').trim()] || '';
                if (value) {
                  textContent += `${labelForText} ${value}\n`;
                }
              });
            }
          });
        }
        return textContent;
      }

      // Funci√≥n para generar y descargar el PDF
      async function downloadPdf() {
        if (typeof window.jspdf === 'undefined') {
          alert(
            'La librer√≠a jsPDF no est√° cargada. Por favor, aseg√∫rese de incluirla.'
          );
          return;
        }

        const {
          jsPDF
        } = window
          .jspdf; // Acceder a jsPDF desde window.jspdf si se carga con UMD
        const doc = new jsPDF();

        let yOffset = 15;
        const margin = 10;
        const lineHeight = 7;
        const imgDisplayWidth = 80; // Ancho fijo para las im√°genes en el PDF
        const textWidth = 190; // Ancho m√°ximo de texto en la p√°gina

        doc.setFontSize(18);
        doc.text("Informe de Marcado de V√≠deo", doc.internal.pageSize
          .width / 2,
          yOffset, {
            align: 'center'
          });
        yOffset += 15;

        // Informaci√≥n General
        doc.setFontSize(14);
        doc.text("Informaci√≥n General", margin, yOffset);
        yOffset += lineHeight;
        doc.setFontSize(10);
        doc.text(`Usuario: ${getMoodleUserName()}`, margin, yOffset);
        yOffset += lineHeight;
        doc.text(`T√≠tulo del v√≠deo: ${currentVideoTitle}`, margin,
          yOffset);
        yOffset += lineHeight;
        doc.text(
          `Instante de tiempo: ${mainVideoPlayer.currentTime.toFixed(2)} segundos`,
          margin, yOffset);
        yOffset += 15;

        // Im√°genes de Fotogramas
        doc.setFontSize(14);
        doc.text("Fotogramas Capturados", margin, yOffset);
        yOffset += lineHeight;

        const originalImgSrc = originalFrameImage.src;
        const markedImgSrc = markedFrameImage.src;

        // Capturar las dimensiones reales del video para calcular las alturas proporcionales
        const videoNativeWidth = mainVideoPlayer.videoWidth;
        const videoNativeHeight = mainVideoPlayer.videoHeight;
        let originalImgDisplayHeight = imgDisplayWidth; // Valor por defecto
        let markedImgDisplayHeight = imgDisplayWidth; // Valor por defecto

        if (videoNativeWidth > 0 && videoNativeHeight > 0) {
            const aspectRatio = videoNativeWidth / videoNativeHeight;
            originalImgDisplayHeight = imgDisplayWidth / aspectRatio;
            markedImgDisplayHeight = imgDisplayWidth / aspectRatio;
        }


        // Usar addImage directamente para mantener la simplicidad, asumiendo que las dimensiones se calculan aqu√≠
        if (originalImgSrc && originalImgSrc.startsWith('data:')) {
          doc.addImage(originalImgSrc, 'PNG', margin, yOffset, imgDisplayWidth,
            originalImgDisplayHeight); // Usar altura calculada
          doc.setFontSize(9);
          doc.text("Fotograma original", margin, yOffset +
            originalImgDisplayHeight + 4);
        } else {
          doc.setFontSize(9);
          doc.text("Fotograma original (no disponible)", margin, yOffset + 4);
        }

        if (markedImgSrc && markedImgSrc.startsWith('data:')) {
          doc.addImage(markedImgSrc, 'PNG', margin + imgDisplayWidth + 10,
            yOffset,
            imgDisplayWidth, markedImgDisplayHeight); // Usar altura calculada
          doc.setFontSize(9);
          doc.text("Fotograma con marcas", margin + imgDisplayWidth + 10,
            yOffset +
            markedImgDisplayHeight + 4);
        } else {
          doc.setFontSize(9);
          doc.text("Fotograma con marcas (no disponible)", margin +
            imgDisplayWidth +
            10, yOffset + 4);
        }
        yOffset += Math.max(originalImgDisplayHeight, markedImgDisplayHeight) +
        20; // Espacio despu√©s de las im√°genes y sus t√≠tulos


        // Informaci√≥n del Marcado
        doc.setFontSize(14);
        doc.text("Informaci√≥n del Marcado", margin, yOffset);
        yOffset += lineHeight;

        if (videoAnnotations.length === 0) {
          doc.setFontSize(10);
          doc.text("No se han a√±adido marcas.", margin, yOffset);
          yOffset += lineHeight;
        } else {
          doc.setFontSize(10);
          videoAnnotations.forEach(annotation => {
            const annotationTitle =
              `Marca ${annotation.number} (Color: ${annotation.color})`; // Eliminado ":" final
            const annotationPos =
              `Posici√≥n: (X = ${annotation.x.toFixed(2)}; Y = ${annotation.y.toFixed(2)})`;

            // Check for new page if content overflows
            if (yOffset + lineHeight * 4 > doc.internal.pageSize
              .height - margin) {
              doc.addPage();
              yOffset = margin; // Reset yOffset for new page
            }

            // T√≠tulo de la marca en negrita
            doc.setFont('helvetica', 'bold');
            doc.text(annotationTitle, margin, yOffset);
            yOffset += lineHeight;
            doc.setFont('helvetica', 'normal'); // Restablecer a normal

            doc.text(annotationPos, margin, yOffset);
            yOffset += lineHeight;

            if (annotation.formFields) {
              formFieldsDefinition.forEach(fieldDef => {
                const cleanedLabel = fieldDef.etiqueta.replace(':', '')
                  .trim();
                const value = annotation.formFields[cleanedLabel] || '';
                if (value) {
                  // Asegurarse de que la etiqueta no tenga doble "::"
                  let labelForPdf = fieldDef.etiqueta;
                  if (!labelForPdf.endsWith(':') && labelForPdf.trim() !== '') {
                      labelForPdf += ':';
                  }

                  const formattedFieldText = `${labelForPdf} ${value}`;
                  const splitText = doc.splitTextToSize(formattedFieldText, textWidth);


                  // Check for new page before adding multi-line text
                  if (yOffset + lineHeight * splitText.length >
                    doc.internal
                    .pageSize.height - margin) {
                    doc.addPage();
                    yOffset = margin;
                  }

                  doc.text(splitText, margin,
                    yOffset); // CORREGIDO: Eliminada la indentaci√≥n (+5)
                  yOffset += lineHeight * splitText.length;
                }
              });
            }
            yOffset += lineHeight * 0.5; // Espacio entre marcas
          });
        }

        doc.save(`${generateBaseFileName()}.pdf`);
        alert('PDF generado y descargado.');
      }

      // Funci√≥n para descargar la imagen del fotograma con marcas
      function downloadImage() {
        const markedImgSrc = markedFrameImage.src;
        if (markedImgSrc && markedImgSrc.startsWith('data:')) {
          if (typeof saveAs === 'undefined') {
            alert(
              'La librer√≠a FileSaver.js no est√° cargada. Por favor, aseg√∫rese de incluirla.'
            );
            return;
          }
          const fileName = `${generateBaseFileName()}.png`;
          // Convertir Data URL a Blob y usar saveAs
          fetch(markedImgSrc)
            .then(res => res.blob())
            .then(blob => {
                saveAs(blob, fileName);
                alert('Imagen generada y descargada.'); // **A√ëADIDO: Alerta de confirmaci√≥n**
            })
            .catch(e => {
              console.error('Error al descargar la imagen:', e);
              alert(
                'No se pudo descargar la imagen. Verifique la consola para m√°s detalles.'
              );
            });
        } else {
          alert(
            'La imagen del fotograma con marcas no est√° disponible para descargar.'
          );
        }
      }

      // Funci√≥n para descargar un archivo ZIP con los contenidos o subir a Moodle
      async function downloadZip(submitToMoodle = false) {
        if (typeof JSZip === 'undefined' || typeof saveAs ===
          'undefined') {
          alert(
            'Las librer√≠as JSZip y/o FileSaver.js no est√°n cargadas. Por favor, aseg√∫rese de incluirlas.'
          );
          return;
        }

        const zip = new JSZip();
        const baseFileName = generateBaseFileName();
        const zipFileName = `${baseFileName}.zip`;

        // 1. A√±adir imagen original
        const originalImgSrc = originalFrameImage.src;
        if (originalImgSrc && originalImgSrc.startsWith('data:')) {
          zip.file('imagen_original.png', originalImgSrc.split(',')[1], {
            base64: true
          });
        } else {
          console.warn('Imagen original no disponible para el ZIP.');
        }

        // 2. A√±adir imagen marcada
        const markedImgSrc = markedFrameImage.src;
        if (markedImgSrc && markedImgSrc.startsWith('data:')) {
          zip.file('imagen_marcada.png', markedImgSrc.split(',')[1], {
            base64: true
          });
        } else {
          console.warn('Imagen marcada no disponible para el ZIP.');
        }

        // 3. A√±adir el archivo de informaci√≥n
        const infoContent = generateReportTextContent();
        zip.file('informacion.txt', infoContent);

        try {
          const content = await zip.generateAsync({
            type: "blob"
          });

          if (submitToMoodle) {
              // L√≥gica para intentar subir a Moodle
              await submitFileToMoodle(content, zipFileName);
          } else {
              // L√≥gica de descarga normal
              saveAs(content, zipFileName);
              alert('Archivo ZIP generado y descargado.');
          }
        } catch (error) {
          console.error("Error al generar el ZIP o subir a Moodle:", error);
          alert(
            'No se pudo generar el archivo ZIP o subirlo a Moodle. Verifique la consola para m√°s detalles.'
          );
        }
      }

      // NUEVA FUNCI√ìN: L√≥gica para subir un archivo (Blob) a Moodle
      async function submitFileToMoodle(fileBlob, fileName) {
          const file = new File([fileBlob], fileName, { type: "application/zip" });

          // Paso 1: Click en el bot√≥n "A√±adir fichero" de Moodle
          const addFileButton = document.querySelector('.fp-btn-add');
          if (!addFileButton) {
              alert('No se encontr√≥ el bot√≥n "A√±adir fichero" de Moodle. La subida autom√°tica puede no ser posible.');
              console.error('Moodle upload: Could not find .fp-btn-add');
              return;
          }
          addFileButton.click();

          // Esperar a que el selector de archivos de Moodle se abra y el input de tipo file est√© disponible
          // Usamos un bucle con retardo para buscar el elemento de forma persistente
          let fileInput = null;
          let uploadButton = null;
          let attempts = 0;
          const maxAttempts = 20; // Intentar durante 2 segundos (100ms * 20)

          while (!fileInput && attempts < maxAttempts) {
              await new Promise(resolve => setTimeout(resolve, 100)); // Esperar 100ms
              fileInput = document.querySelector('input[name="repo_upload_file"]');
              attempts++;
          }
          
          if (!fileInput) {
              alert('No se encontr√≥ el campo de subida de archivo de Moodle. La subida autom√°tica puede no ser posible.');
              console.error('Moodle upload: Could not find input[name="repo_upload_file"]');
              return;
          }

          // Crear un DataTransfer para asignar el archivo al input
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;

          // Disparar eventos para que Moodle detecte el cambio (importante para que Moodle procese el archivo)
          const changeEvent = new Event('change', { bubbles: true });
          fileInput.dispatchEvent(changeEvent);
          
          // Opcional: Si Moodle usa un input 'blur' para validar, aunque 'change' deber√≠a ser suficiente
          const blurEvent = new Event('blur', { bubbles: true });
          fileInput.dispatchEvent(blurEvent);


          // Paso 2: Esperar a que Moodle procese el archivo y muestre el bot√≥n de subir
          // El bot√≥n 'Subir este archivo' (.fp-upload-btn) puede aparecer despu√©s de que el archivo sea reconocido
          attempts = 0;
          while (!uploadButton && attempts < maxAttempts) {
              await new Promise(resolve => setTimeout(resolve, 100));
              uploadButton = document.querySelector('.fp-upload-btn');
              attempts++;
          }

          if (!uploadButton) {
              alert('No se encontr√≥ el bot√≥n "Subir este archivo" de Moodle. La subida autom√°tica puede no ser posible o requerir confirmaci√≥n manual.');
              console.error('Moodle upload: Could not find .fp-upload-btn');
              return;
          }
          
          // Deshabilitar la modal de informe mientras la subida de Moodle est√© activa
          reportModalOverlay.style.display = 'none';

          // Click en el bot√≥n "Subir este archivo"
          uploadButton.click();

          alert('Archivo ZIP intentando subirse a Moodle. Por favor, verifique la bandeja de entrega de la tarea.');
      }


      // Modificaci√≥n de la funci√≥n showReportModal para integrar las nuevas funciones de descarga
      async function showReportModal() {
        if (!mainVideoPlayer.src) {
          alert('Por favor, seleccione un v√≠deo primero.');
          return;
        }

        // Establecer t√≠tulo de la modal seg√∫n el tipo de recurso Moodle
        if (MOODLE_RESOURCE_TYPE === 'page') {
          modalTitle.textContent = 'Informaci√≥n de la descarga';
        } else if (MOODLE_RESOURCE_TYPE === 'assign') {
          modalTitle.textContent = 'Entregar informe';
        }

        // --- Informaci√≥n General ---
        reportUser.textContent = getMoodleUserName();
        reportVideoTitle.textContent = currentVideoTitle;
        reportMarkTime.textContent =
          `${mainVideoPlayer.currentTime.toFixed(2)} segundos`;

        // --- Captura de im√°genes ---
        // Asegurar que el v√≠deo est√© listo antes de intentar capturar fotogramas
        if (mainVideoPlayer.readyState >=
          2) { // READY_STATE_HAVE_CURRENT_DATA
          // Fotograma original
          try {
            const originalCanvas = document.createElement('canvas');
            originalCanvas.width = mainVideoPlayer.videoWidth;
            originalCanvas.height = mainVideoPlayer.videoHeight;
            const originalCtx = originalCanvas.getContext('2d');
            originalCtx.drawImage(mainVideoPlayer, 0, 0, originalCanvas
              .width,
              originalCanvas.height);
            originalFrameImage.src = originalCanvas.toDataURL(
              'image/png');
            originalFrameImage.style.display = 'block';
            originalFrameImage.nextElementSibling.style.display =
              'none'; // Ocultar mensaje de error
          } catch (e) {
            console.error("Error capturing original frame:", e);
            originalFrameImage.style.display = 'none';
            originalFrameImage.nextElementSibling.style.display =
              'block'; // Mostrar mensaje de error
          }

          // Fotograma con marcas
          try {
            const markedCanvas = document.createElement('canvas');
            markedCanvas.width = mainVideoPlayer.videoWidth;
            markedCanvas.height = mainVideoPlayer.videoHeight;
            const markedCtx = markedCanvas.getContext('2d');
            markedCtx.drawImage(mainVideoPlayer, 0, 0, markedCanvas.width,
              markedCanvas.height);

            // Dibujar todas las anotaciones en el canvas de marcado, escal√°ndolas al tama√±o de captura
            videoAnnotations.forEach(annotation => {
              drawCircleWithNumberOnContext(
                markedCtx,
                annotation,
                markedCanvas.width,
                markedCanvas.height
              );
            });
            markedFrameImage.src = markedCanvas.toDataURL('image/png');
            markedFrameImage.style.display = 'block';
            markedFrameImage.nextElementSibling.style.display =
              'none'; // Ocultar mensaje de error
          } catch (e) {
            console.error("Error capturing marked frame:", e);
            markedFrameImage.style.display = 'none';
            markedFrameImage.nextElementSibling.style.display =
              'block'; // Mostrar mensaje de error
          }
        } else {
          // Si el v√≠deo no est√° listo, mostrar mensajes de error para ambos
          originalFrameImage.style.display = 'none';
          originalFrameImage.nextElementSibling.style.display = 'block';
          markedFrameImage.style.display = 'none';
          markedFrameImage.nextElementSibling.style.display = 'block';
        }


        // --- Informaci√≥n del Marcado ---
        marksList.innerHTML = ''; // Limpiar marcas previas
        if (videoAnnotations.length === 0) {
          marksList.innerHTML = '<li>No se han a√±adido marcas.</li>';
        } else {
          videoAnnotations.forEach(annotation => {
            const li = document.createElement('li');
            let formFieldsHtml = '';
            if (annotation.formFields) {
              formFieldsDefinition.forEach(fieldDef => {
                const cleanedLabel = fieldDef.etiqueta.replace(':', '')
                  .trim();
                const value = annotation.formFields[cleanedLabel] || '';
                if (value) {
                  formFieldsHtml +=
                    `<br>${fieldDef.etiqueta} <span>${value}</span>`;
                }
              });
            }

            // MODIFICADO: Formato de Posici√≥n: Posici√≥n: (X = [valorX]; Y = [valorY]) con dos decimales
            const posX = annotation.x.toFixed(2);
            const posY = annotation.y.toFixed(2);

            // MODIFICADO: Eliminado "Tiempo" del encabezado de marca y "Color" en negrita
            li.innerHTML = `
                <strong class="mark-header-text">Marca ${annotation.number}</strong> (<strong class="mark-header-text">Color: ${annotation.color}</strong>):<br>
                Posici√≥n: (X = ${posX}; Y = ${posY})${formFieldsHtml}
            `;
            marksList.appendChild(li);
          });
        }

        // --- Botones del Footer ---
        modalFooterButtons.innerHTML = '';
        if (MOODLE_RESOURCE_TYPE === 'page') {
          const downloadPdfButton = document.createElement('button');
          downloadPdfButton.id = 'downloadPdfButton';
          // MODIFICADO: Cambiado a 'secondary-button' para que sea gris
          downloadPdfButton.classList.add('custom-button', 'secondary-button');
          downloadPdfButton.textContent = 'Descargar PDF';
          downloadPdfButton.onclick = downloadPdf; // Asignar la nueva funci√≥n

          const downloadImgButton = document.createElement('button');
          downloadImgButton.id = 'downloadImgButton';
          downloadImgButton.classList.add('custom-button',
            'secondary-button');
          downloadImgButton.textContent = 'Descargar Imagen';
          downloadImgButton.onclick = downloadImage; // Asignar la nueva funci√≥n

          const downloadZipButton = document.createElement('button');
          downloadZipButton.id = 'downloadZipButton';
          downloadZipButton.classList.add('custom-button',
            'secondary-button');
          downloadZipButton.textContent = 'Descargar ZIP';
          downloadZipButton.onclick = () => downloadZip(false); // Llamar a downloadZip sin submitToMoodle
          
          modalFooterButtons.appendChild(downloadPdfButton);
          modalFooterButtons.appendChild(downloadImgButton);
          modalFooterButtons.appendChild(downloadZipButton);

        } else if (MOODLE_RESOURCE_TYPE === 'assign') {
          const confirmSubmitButton = document.createElement('button');
          confirmSubmitButton.id = 'confirmSubmitButton';
          confirmSubmitButton.classList.add('custom-button',
            'primary-button', 'confirm-submit-button');
          confirmSubmitButton.textContent = 'Confirmar entrega';
          confirmSubmitButton.onclick = () => downloadZip(true); // Llamar a downloadZip con submitToMoodle = true
          modalFooterButtons.appendChild(confirmSubmitButton);
        }

        reportModalOverlay.style.display = 'flex';
      }

      // Event listeners para la modal
      closeButton.addEventListener('click', () => {
        reportModalOverlay.style.display = 'none';
      });

      reportModalOverlay.addEventListener('click', (event) => {
        if (event.target === reportModalOverlay) {
          reportModalOverlay.style.display = 'none';
        }
      });


      loadData(JSON_FILENAME_TO_LOAD);

      // --- Inyecci√≥n de estilos CSS ---
      const style = document.createElement('style');
      style.textContent = `
        /* Contenedor principal que centra todo el contenido de la herramienta */
        .main-centered-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Contenedor del selector de v√≠deo (primera tarjeta) */
        .video-selector-card {
            text-align: center;
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            margin-bottom: 30px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            box-sizing: border-box;
        }

        .video-selector-card h1 {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .select-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        #videoSelect, #colorSelect {
            width: 100%;
            padding: 12px 15px;
            font-size: 1em;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            background-color: #ffffff;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            color: #555;
        }

        #videoSelect:focus, #colorSelect:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .select-wrapper::after {
            content: '‚åÑ';
            font-size: 1.2em;
            color: #888;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        /* Contenedor que alinea horizontalmente el reproductor y el formulario */
        .video-and-form-wrapper {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            max-width: 1200px;
            gap: 30px;
            flex-wrap: wrap;
        }

        /* Contenedor del reproductor de v√≠deo */
        .video-player-card {
            width: 90%;
            max-width: 700px;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            padding: 5px;
            border: 1px solid #e0e0e0;
            box-sizing: border-box;
            transition: max-width 0.3s ease-in-out;
        }

        /* Clase para reducir el tama√±o del reproductor cuando el formulario est√° visible */
        .video-player-card.shrink-player {
            max-width: 450px;
        }

        /* Wrapper para el video y el canvas superpuesto */
        .video-canvas-wrapper {
            position: relative;
            width: 100%;
            height: auto;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        /* Estilos para el elemento <video> */
        #mainVideoPlayer {
            width: 100%;
            height: 100%;
            min-height: 250px;
            display: block;
            border-radius: 6px;
            object-fit: contain;
            background-color: black;
        }

        /* Estilos para el Canvas de marcado */
        #markingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 10;
        }

        /* Estilos para el Tooltip de anotaci√≥n */
        .annotation-tooltip {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            text-align: left;
            line-height: 1.4;
            max-width: 250px;
        }
        .annotation-tooltip strong {
            font-weight: 600;
        }
        .annotation-tooltip span {
            font-weight: 400;
        }

        /* Estilos para el mensaje de placeholder */
        .video-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ccc;
            font-size: 1.1em;
            text-align: center;
            padding: 15px;
        }

        /* Contenedor de los botones personalizados debajo del v√≠deo */
        .custom-video-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
            padding: 10px 0;
            flex-shrink: 0;
            margin-top: auto;
        }

        /* Estilos para los botones personalizados (general) */
        .custom-button {
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, opacity 0.2s ease;
            flex-grow: 1;
            max-width: 150px;
            box-sizing: border-box;
            white-space: nowrap;
            padding: 10px 20px;
        }

        /* Estilos para el bot√≥n principal (Reproducir) */
        .custom-button.primary-button {
            background-color: #007bff;
            color: white;
        }
        .custom-button.primary-button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .custom-button.primary-button:active {
            background-color: #004085;
            transform: translateY(0);
        }

        /* Estilos para el bot√≥n secundario (Marcar) */
        .custom-button.secondary-button {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #dcdcdc;
        }
        .custom-button.secondary-button:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }
        .custom-button.secondary-button:active {
            background-color: #d0d0d0;
            transform: translateY(0);
        }

        /* Estilos para el nuevo bot√≥n de reporte (Opciones de descarga/Entregar informe) */
        .custom-button.report-button {
            margin-top: 20px;
            width: 100%;
            max-width: 250px;
            align-self: center;
            flex-grow: 0;
        }
        .custom-button.report-button.primary-button {
            background-color: #28a745;
        }
        .custom-button.report-button.primary-button:hover {
            background-color: #218838;
        }
        .custom-button.report-button.primary-button:active {
            background-color: #1e7e34;
        }


        /* Contenedor del formulario de marcado */
        .marking-form-card {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 450px;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            align-self: flex-start;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .marking-form-card h2 {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: left;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #444;
            font-size: 0.95em;
        }

        .form-input {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #dcdcdc;
            border-radius: 6px;
            font-size: 1em;
            color: #555;
            background-color: #ffffff;
            box-sizing: border-box;
        }

        .form-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        /* Estilos espec√≠ficos para el selector de color */
        #colorSelect {
            padding-left: 40px;
        }

        /* Estilos para el bot√≥n "A√±adir Anotaci√≥n" */
        .custom-button.annotation-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            white-space: nowrap;
            flex-grow: 0;
            align-self: center;
            margin-top: auto;
            max-width: 250px;
        }
        .custom-button.annotation-button:hover:not(:disabled) {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .custom-button.annotation-button:active:not(:disabled) {
            background-color: #004085;
            transform: translateY(0);
        }

        /* Estilo para los botones deshabilitados */
        .custom-button[disabled], .custom-button.disabled-button {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
            box-shadow: none;
            transform: none;
        }


        /* Estilos de la Ventana Modal */
        .report-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        }

        .report-modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-title {
            font-size: 1.8em;
            color: #333;
            margin-top: 0;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 500;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 2em;
            cursor: pointer;
            color: #888;
            transition: color 0.2s ease;
        }
        .close-button:hover {
            color: #333;
        }

        .modal-body {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-section {
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        .modal-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .modal-section h3 {
            font-size: 1.3em;
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .modal-section p {
            margin-bottom: 8px;
        }
        /* MODIFICADO: Solo el strong dentro de la lista de marcas */
        .modal-section p span {
            font-weight: normal;
        }

        .image-previews {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .image-preview-item {
            text-align: center;
            background-color: #f0f2f5;
            padding: 10px;
            border-radius: 5px;
            flex: 1 1 300px;
            max-width: 350px;
            box-sizing: border-box;
        }
        .image-preview-item h4 {
            font-size: 1em;
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-weight: 500;
        }
        .image-preview-item img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-preview-item .error-message {
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 10px;
        }

        #marksList {
            list-style: none;
            padding-left: 0;
        }
        #marksList li {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 12px 15px;
            margin-bottom: 10px;
            line-height: 1.5;
            font-size: 0.95em;
        }
        #marksList li:last-child {
            margin-bottom: 0;
        }
        /* MODIFICADO: Estilos para el encabezado de la marca en la lista */
        #marksList li strong.mark-header-text { /* NUEVO selector */
            font-size: 1.1em; /* Un poco m√°s grande y negrita para el t√≠tulo de la marca */
            font-weight: 600;
            color: #333;
        }
        /* MODIFICADO: Para la descripci√≥n, mantener normal */
        #marksList li span {
            font-weight: normal;
        }


        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .modal-footer .custom-button {
            flex-grow: 0;
            max-width: none;
            padding: 12px 25px;
        }
        .modal-footer .custom-button.primary-button {
             background-color: #007bff;
        }
        .modal-footer .custom-button.primary-button:hover {
            background-color: #0056b3;
        }
        .modal-footer .custom-button.primary-button.confirm-submit-button {
            background-color: #28a745;
        }
        .modal-footer .custom-button.primary-button.confirm-submit-button:hover {
            background-color: #218838;
        }
        .modal-footer .custom-button.secondary-button {
            background-color: #e9ecef;
            color: #333;
            border: 1px solid #dcdcdc;
        }
        .modal-footer .custom-button.secondary-button:hover {
            background-color: #dae0e5;
        }


        /* Ajustes responsivos para la modal */
        @media (max-width: 768px) {
            .report-modal-content {
                width: 95%;
                padding: 20px;
            }
            .image-previews {
                flex-direction: column;
                align-items: center;
            }
            .image-preview-item {
                max-width: 100%;
            }
            .modal-footer {
                flex-direction: column;
                align-items: stretch;
            }
            .modal-footer .custom-button {
                max-width: 100%;
            }
        }
    `;
      document.head.appendChild(style);
    });
  </script>
</p>
content_copydownload
